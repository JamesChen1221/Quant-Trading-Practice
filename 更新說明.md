# 程式更新說明

## ✅ 已完成的調整

### 1. 計算邏輯修正
- **原本**：計算開盤日期**之後**的資料（需要未來資料）
- **現在**：計算開盤日期**之前**的資料（過去 5 天和過去 30 天）
- **排序**：從最近到最遠（最新的資料在序列開頭）

### 2. 增量計算功能
- ✅ 自動檢測已有計算結果的項目
- ✅ 跳過已完整計算的資料
- ✅ 只處理新增或不完整的項目
- ✅ 顯示處理統計（新計算、跳過、失敗）

### 3. 讀取指定工作表
- ✅ 從「量化交易.xlsx」的「資料庫」工作表讀取
- ✅ 保留其他工作表（如「資料定義」）
- ✅ 直接更新原檔案

---

## 📊 測試結果

### 執行結果
```
正在讀取 量化交易.xlsx 的 '資料庫' 工作表...
共有 4 筆資料

處理第 1 筆: TER (日期: 2026-02-03)
  正在下載 TER 的資料...
  ✓ 完成 (實際資料: 48 天)
  RSI 5天前3筆: [78.52, 69.18, 68.51]

處理第 2 筆: PLTR (日期: 2026-02-03)
  正在下載 PLTR 的資料...
  ✓ 完成 (實際資料: 48 天)
  RSI 5天前3筆: [29.81, 12.79, 14.3]

處理第 3 筆: LITE (日期: 2025-02-04)
  正在下載 LITE 的資料...
  ✓ 完成 (實際資料: 47 天)
  RSI 5天前3筆: [51.13, 50.52, 50.63]

處理第 4 筆: KMT (日期: 2026-02-04)
  正在下載 KMT 的資料...
  ✓ 完成 (實際資料: 48 天)
  RSI 5天前3筆: [78.39, 70.06, 78.34]

============================================================
處理完成統計:
  新計算: 4 筆
  已跳過: 0 筆（已有資料或資料不完整）
  失敗: 0 筆
  總計: 4 筆
============================================================
```

### 第二次執行（測試跳過功能）
```
跳過第 1 筆: TER (日期: 2026-02-03) - 已有計算結果
跳過第 2 筆: PLTR (日期: 2026-02-03) - 已有計算結果
跳過第 3 筆: LITE (日期: 2025-02-04) - 已有計算結果
跳過第 4 筆: KMT (日期: 2026-02-04) - 已有計算結果

============================================================
處理完成統計:
  新計算: 0 筆
  已跳過: 4 筆（已有資料或資料不完整）
  失敗: 0 筆
  總計: 4 筆
============================================================
```

✅ **增量計算功能正常運作！**

---

## 🔍 資料解讀

### 範例：TER (2026-02-03)

**5天 RSI 序列：** `[78.52, 69.18, 68.51, 82.70, 73.66]`

解讀：
- **78.52**（最近一天）：超買區（>70），可能回調
- **69.18**（前一天）：接近超買
- **68.51**（再前一天）：中性偏強
- 趨勢：RSI 在高位震盪，顯示強勢但可能過熱

**5天 ADX 序列：** `[28.39, 27.57, 28.36, 28.37, 27.95]`

解讀：
- **28.39**（最近一天）：中等趨勢強度（>25）
- 趨勢：ADX 穩定在 27-28 之間，顯示有一定趨勢但不算很強

### 範例：PLTR (2026-02-03)

**5天 RSI 序列：** `[29.81, 12.79, 14.30, 17.65, 17.96]`

解讀：
- **29.81**（最近一天）：接近超賣區（<30）
- **12.79**（前一天）：嚴重超賣
- 趨勢：RSI 從極度超賣（12.79）反彈至 29.81，可能出現反轉

---

## 📝 使用方式

### 執行程式
```cmd
python calculate_indicators.py
```

### 新增資料
1. 在「資料庫」工作表中新增一行
2. 填入「公司代碼」和「開盤日期(台灣時間)」
3. 執行程式
4. 程式會自動計算新增的項目，跳過已有資料的項目

### 重新計算
如果想重新計算某個項目：
1. 刪除該行的 RSI/ADX 序列資料（清空或填入空白）
2. 執行程式
3. 程式會重新計算該項目

---

## 🎯 技術細節

### 計算參數
- **RSI 週期**：n = 14（業界標準）
- **ADX 週期**：n = 14（業界標準）
- **5 天序列**：開盤日期之前最近 5 個交易日
- **30 天序列**：開盤日期之前最近 30 個交易日

### 資料抓取
- **時間範圍**：開盤日期前 90 天 ~ 開盤日期當天
- **資料來源**：Yahoo Finance (透過 yfinance)
- **排序方式**：從最近到最遠

### 跳過條件
程式會跳過以下情況：
- ✅ 四個欄位（5天 RSI、1個月 RSI、5天 ADX、1個月 ADX）都有資料
- ✅ 資料不是空序列 `[]`
- ✅ 資料不是 `NaN` 或空白

---

## 📚 相關文件

- **calculate_indicators.py** - 主程式（已更新）
- **技術說明_RSI_ADX計算.md** - 詳細計算公式和邏輯（已更新）
- **執行說明.md** - 使用說明
- **量化交易.xlsx** - 資料檔案

---

## 💡 建議

1. **定期執行**：每次新增資料後執行一次即可
2. **批次處理**：可以一次新增多筆資料，程式會自動處理
3. **資料驗證**：檢查 RSI 和 ADX 數值是否合理（RSI: 0-100, ADX: 0-100）
4. **備份資料**：建議定期備份 Excel 檔案

---

## ✨ 優勢

1. **增量計算**：不會重複計算已有資料，節省時間
2. **自動跳過**：智能識別已完成的項目
3. **統計資訊**：清楚顯示處理結果
4. **保留工作表**：不會影響其他工作表的資料
5. **過去資料**：計算開盤前的趨勢，用於預測開盤後走勢
