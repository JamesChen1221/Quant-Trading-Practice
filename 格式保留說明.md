# Excel 格式保留說明

## ✅ 問題已解決

### 問題
之前使用 `pandas.to_excel()` 會重新創建整個 Excel 檔案，導致：
- ❌ 字型格式丟失
- ❌ 字體大小重置
- ❌ 日期格式改變
- ❌ 儲存格顏色、邊框等格式消失

### 解決方案
現在使用 `openpyxl` 直接操作 Excel 儲存格：
- ✅ 只更新需要修改的儲存格
- ✅ 保留所有原有格式
- ✅ 保留其他工作表
- ✅ 保留公式、圖表等

---

## 🔄 序列排序已調整

### 之前（從最近到最遠）
```python
[78.52, 69.18, 68.51, 82.70, 73.66]
 ↑最近  ↑第2   ↑第3   ↑第4   ↑第5
```

### 現在（從最遠到最近）
```python
[73.66, 82.70, 68.51, 69.18, 78.52]
 ↑第5   ↑第4   ↑第3   ↑第2   ↑最近
```

這樣的排序更符合時間序列的習慣，從過去到現在。

---

## 📊 實際測試結果

### TER (2026-02-03)

**5天 RSI 序列：**
```
[73.66, 82.70, 68.51, 69.18, 78.52]
```

解讀（從左到右，從過去到現在）：
1. **73.66**（第5天前）：偏強
2. **82.70**（第4天前）：超買
3. **68.51**（第3天前）：中性偏強
4. **69.18**（第2天前）：接近超買
5. **78.52**（第1天前/最近）：超買

趨勢：RSI 在高位震盪，最近一天達到 78.52，顯示強勢但可能過熱。

---

## 🛠️ 技術實作

### 使用 openpyxl 保留格式

```python
from openpyxl import load_workbook

# 載入現有工作簿（保留所有格式）
wb = load_workbook('量化交易.xlsx')
ws = wb['資料庫']

# 只更新特定儲存格
ws.cell(row=2, column=10).value = "[73.66, 82.70, 68.51, 69.18, 78.52]"

# 儲存（格式完全保留）
wb.save('量化交易.xlsx')
wb.close()
```

### 與 pandas 的差異

| 方法 | 優點 | 缺點 |
|------|------|------|
| **pandas.to_excel()** | 簡單快速 | ❌ 丟失所有格式 |
| **openpyxl** | ✅ 保留所有格式 | 需要找到正確的儲存格位置 |

---

## 📝 程式執行流程

1. **讀取資料**：使用 pandas 讀取 Excel（快速）
2. **計算指標**：下載股價並計算 RSI/ADX
3. **儲存更新**：使用 openpyxl 直接寫入儲存格（保留格式）

```
pandas 讀取 → 計算處理 → openpyxl 寫入
   ↓              ↓              ↓
快速讀取      業務邏輯      保留格式
```

---

## ✨ 優勢

### 1. 格式完全保留
- 字型、字體大小
- 顏色、背景色
- 邊框、對齊方式
- 日期格式
- 數字格式
- 條件格式

### 2. 效能優化
- 只更新需要修改的儲存格
- 不重新創建整個檔案
- 保留其他工作表不變

### 3. 安全性
- 不會影響其他資料
- 不會破壞公式
- 不會刪除圖表

---

## 🎯 使用建議

### 第一次使用
1. 在 Excel 中設定好所有格式（字型、顏色、邊框等）
2. 執行程式計算 RSI/ADX
3. 格式會完全保留

### 日常使用
1. 新增資料行時，複製上一行的格式
2. 執行程式
3. 新資料會填入，格式保持一致

### 批次處理
1. 一次新增多筆資料
2. 執行一次程式
3. 所有新資料都會計算並填入

---

## 🔍 驗證方法

### 檢查格式是否保留
1. 執行程式前，記下某個儲存格的格式（如字型、顏色）
2. 執行程式
3. 檢查該儲存格格式是否相同

### 檢查序列排序
```python
import pandas as pd

df = pd.read_excel('量化交易.xlsx', sheet_name='資料庫')
print(df.loc[0, '5天 RSI 序列'])

# 應該顯示：[第5天前, 第4天前, 第3天前, 第2天前, 第1天前]
```

---

## 💡 常見問題

### Q: 為什麼之前格式會跑掉？
A: 因為 `pandas.to_excel()` 會重新創建 Excel 檔案，所有格式都會重置為預設值。

### Q: 現在如何保留格式？
A: 使用 `openpyxl` 直接操作儲存格，只修改內容不改變格式。

### Q: 序列排序是什麼順序？
A: 從最遠到最近（從過去到現在）：`[第5天前, 第4天前, 第3天前, 第2天前, 第1天前]`

### Q: 如果我想改回從最近到最遠？
A: 修改 `calculate_indicators.py` 中的這一行：
```python
# 改為反轉順序
rsi_5 = rsi_series.tail(days_5).tolist()[::-1]
```

### Q: 會影響其他工作表嗎？
A: 不會，只更新「資料庫」工作表的特定儲存格。

---

## 📚 相關檔案

- **calculate_indicators.py** - 主程式（已更新為使用 openpyxl）
- **量化交易.xlsx** - 資料檔案（格式會完全保留）

---

## 🎉 總結

✅ **格式保留**：使用 openpyxl 直接操作儲存格
✅ **序列排序**：從最遠到最近（從過去到現在）
✅ **增量計算**：自動跳過已有資料
✅ **效能優化**：只更新需要修改的儲存格

現在你可以放心地在 Excel 中設定任何格式，程式執行後格式都會完全保留！
